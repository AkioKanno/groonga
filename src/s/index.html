<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta name="robots" content="noindex,nofollow,noarchive">
<title>groonga admin</title>
<link rel="stylesheet" type="text/css" href="/s/css/admin.css">
<link rel="stylesheet" type="text/css" href="/s/css/ui-lightness/jquery-ui-1.7.2.custom.css">
<script type="text/javascript" src="/s/js/jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="/s/js/jquery-ui-1.7.2.custom.min.js"></script>
</head>
<body>
<div id="header">
</div>
<div id="body">
  <table>
    <tr>
      <td id="left-column">
        <div id="side-menu">
          テーブル一覧
          <ul id="side-menu-tablelist" />
        </div>
      </td>

      <td id="right-column">
        <!-- database view -->
        <div id="database-tabs">
          <ul>
            <li><a href="#database-tab-summary">サマリー</a></li>
            <li><a href="#database-tab-tablelist" id="tab-tablelist-link">テーブル一覧</a></li>
            <li><a href="#database-tab-createtable">テーブル作成</a></li>
          </ul>
          <div id="database-tab-summary">
            <p>
              groongaの管理ツールです。
            </p>
            <ul>
              <li>開始時間: <span id="status-starttime"></span></li>
              <li>uptime: <span id="status-uptime"></span></li>
            </ul>
          </div>
          <div id="database-tab-tablelist">
          </div>
          <div id="database-tab-createtable">
            <table>
              <tr>
                <td>
                  <label for="createtable-name">テーブル名</label>
                </td>
                <td>
                  <input type="text" id="createtable-name">
                </td>
              </tr>
              <tr>
                <td>
                  主キー
                </td>
                <td>
                  <label for="createtable-key-type">keyの型:</label>
                  <select id="createtable-key-type">
                    <optgroup label="組み込み型" id="createtable-key-type-builtin">
                    </optgroup>
                    <optgroup label="テーブル" id="createtable-key-type-table">
                    </optgroup>
                  </select>
                  <label for="createtable-key-index">keyのインデックス種類:</label>
                  <select id="createtable-key-index">
                    <option value="GRN_OBJ_TABLE_PAT_KEY">パトリシア木</option>
                    <option value="GRN_OBJ_TABLE_HASH_KEY">ハッシュテーブル</option>
                    <option value="GRN_OBJ_TABLE_NO_KEY">キーなし</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>
                  フラグ
                </td>
                <td id="createtable-flags">
                  <input type="checkbox" value="GRN_OBJ_PERSISTENT" checked>永続化</input>
                  <input type="checkbox" value="GRN_OBJ_KEY_NORMALIZE">key文字列の正規化</input>
                  <input type="checkbox" value="GRN_OBJ_KEY_WITH_SIS">key文字列のsuffix登録</input>
                </td>
              </tr>
              <tr>
                <td>
                  value
                </td>
                <td>
                  <input type="text" id="createtable-value-size" value="0">
                </td>
              </tr>
            </table>
            <input type="button" id="createtable-add-table" value="テーブル追加">
          </div>
        </div>

        <!-- table view -->
        <div id="table-tabs">
          <ul>
            <li><a href="#table-tab-recordlist" id="tab-recordlist-link">レコード一覧</a></li>
            <li><a href="#table-tab-columnlist" id="tab-columnlist-link">カラム一覧</a></li>
            <li><a href="#table-tab-createrecord">レコード作成</a></li>
            <li><a href="#table-tab-createcolumn">カラム作成</a></li>
          </ul>
          <div id="table-tab-recordlist">
          </div>
          <div id="table-tab-columnlist">
          </div>
          <div id="table-tab-createrecord">
            <!-- TODO: implement -->
          </div>
          <div id="table-tab-createcolumn">
            <table>
              <tr>
                <td>
                  <label for="createcolumn-name">カラム名</label>
                </td>
                <td>
                  <input type="text" id="createcolumn-name">
                </td>
              </tr>
              <tr>
                <td>
                  設定
                </td>
                <td>
                  <label for="createcolumn-type">型:</label>
                  <select id="createcolumn-type">
                    <optgroup label="組み込み型" id="createcolumn-type-builtin">
                    </optgroup>
                    <optgroup label="テーブル" id="createcolumn-type-table">
                    </optgroup>
                  </select>

                  <label for="createcolumn-column-type">カラム種別:</label>
                  <select id="createcolumn-column-type">
                    <option value="GRN_OBJ_COLUMN_SCALAR">スカラ</option>
                    <option value="GRN_OBJ_COLUMN_VECTOR">ベクタ</option>
                    <option value="GRN_OBJ_COLUMN_INDEX">転置インデックス</option>
                  </select>

                  <label for="createcolumn-compress">圧縮:</label>
                  <select id="createcolumn-compress">
                    <option value="GRN_OBJ_COMPRESS_NONE">圧縮なし</option>
                    <option value="GRN_OBJ_COMPRESS_ZLIB">zlib</option>
                    <option value="GRN_OBJ_COMPRESS_LZO">LZO</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>
                  フラグ
                </td>
                <td id="createcolumn-flags">
                  <input type="checkbox" value="GRN_OBJ_PERSISTENT" checked>永続化</input>
                </td>
              </tr>
              <tr>
                <td>
                  転置インデックス用フラグ
                </td>
                <td id="createcolumn-ii-flags">
                  <input type="checkbox" value="GRN_OBJ_WITH_SECTION">段落情報を含める</input>
                  <input type="checkbox" value="GRN_OBJ_WITH_WEIGHT">重みを含める</input>
                  <input type="checkbox" value="GRN_OBJ_WITH_POSITION">位置情報を含める</input>
                </td>
              </tr>
            </table>
            <input type="button" id="createcolumn-add-column" value="カラム追加">
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>
<div id="footer">
</div>
<script type="text/javascript">
Groonga = {
  key_type_list: ['Int8', 'UInt8', 'Int16', 'UInt16', 'Int32', 'UInt32',
                  'Int64', 'UInt64', 'Float', 'Time', 'ShortText'],
  column_type_list: ['Object', 'Bool',
                     'Int8', 'UInt8', 'Int16', 'UInt16', 'Int32', 'UInt32',
                     'Int64', 'UInt64', 'Float', 'Time', 'ShortText',
                     'Text', 'LongText'],
  GRN_OBJ_PERSISTENT:             (0x01<<15),
  GRN_OBJ_TABLE_HASH_KEY:         (0x00),
  GRN_OBJ_TABLE_PAT_KEY:          (0x01),
  GRN_OBJ_TABLE_NO_KEY:           (0x03),
  GRN_OBJ_KEY_WITH_SIS:           (0x01<<6),
  GRN_OBJ_KEY_NORMALIZE:          (0x01<<7),

  GRN_OBJ_COLUMN_SCALAR:          (0x00),
  GRN_OBJ_COLUMN_VECTOR:          (0x01),
  GRN_OBJ_COLUMN_INDEX:           (0x02),

  GRN_OBJ_COMPRESS_NONE:          (0x00<<4),
  GRN_OBJ_COMPRESS_ZLIB:          (0x01<<4),
  GRN_OBJ_COMPRESS_LZO:           (0x02<<4),
  GRN_OBJ_WITH_SECTION:           (0x01<<7),
  GRN_OBJ_WITH_WEIGHT:            (0x01<<8),
  GRN_OBJ_WITH_POSITION:          (0x01<<9)
};
GroongaAdmin = {
  initialize: function() {
    GroongaAdmin.current_table = null;

    $('#database-tabs').tabs();
    $('#table-tabs').tabs();
    $('#tab-tablelist-link').click(function() {
      GroongaAdmin.tablelist();
    });
    $('#tab-columnlist-link').click(function() {
      GroongaAdmin.columnlist(GroongaAdmin.current_table);
    });
    $('#tab-recordlist-link').click(function() {
      GroongaAdmin.recordlist(GroongaAdmin.current_table, 1, 30);
    });
    $('#createtable-add-table').click(function() {
      GroongaAdmin.createtable();
    });
    $('#createcolumn-add-column').click(function() {
      GroongaAdmin.createcolumn();
    });
    GroongaAdmin.update_tablelist();

    var e1 = $('#createtable-key-type-builtin');
    var e2 = $('#createcolumn-type-builtin');
    $.each(Groonga.key_type_list, function(i, val) {
      e1.append($('<option />').text(val));
      e2.append($('<option />').text(val));
    });
    GroongaAdmin.status();
    setInterval(GroongaAdmin.status, 1000);
  },
  create_table_element: function (d) {
    var table = $('<table/>');
    if ($.isArray(d)) {
      var thead = $('<thead/>').appendTo(table);
      var tbody = $('<tbody/>').appendTo(table);
      var first_line = true;
      $.each(d, function(key) {
        var line = d[key];
        if ($.isArray(line)) {
          var tr = $('<tr/>');
          (first_line ? thead : tbody).append(tr);
          $.each(line, function(l_key) {
            var item = first_line ? $('<th/>') : $('<td/>');
            item.text(line[l_key]);
            tr.append(item);
          });
        }
        first_line = false;
      });
    }
    return table;
  },
  status: function() {
    $.ajax({
      url: '/a/status',
      data: {},
      dataType: 'json',
      success: function(d) {
        $('#status-starttime').text(d.starttime);
        $('#status-uptime').text(d.uptime);
      }
    });
  },
  update_tablelist: function() {
    $.ajax({
      url: '/a/tablelist',
      data: {},
      dataType: 'json',
      success: function(d) {
        d.shift();
        var tl = $('#side-menu-tablelist').empty();
        var tt = $('#createtable-key-type-table').empty();
        var ct = $('#createcolumn-type-table').empty();
        tl.append(
          $('<li />').append(
            $('<a />').attr('href', '#side-menu-database')
                      .text('サマリー')
                      .click(function() {
                        GroongaAdmin.current_table = null;
                        $('#table-tabs').hide();
                        $('#database-tabs').show();
                      })
          )
        )
        $.each(d, function(i, val) {
          var table_name = val[1];
          tl.append(
            $('<li />').append(
              $('<a />')
                .attr('href', '#side-menu-tablelist-' + table_name)
                .text(table_name)
                .click(function() {
                  GroongaAdmin.current_table = table_name;
                  $('#database-tabs').hide();
                  $('#table-tabs').show();
                  GroongaAdmin.columnlist(table_name);
                  GroongaAdmin.recordlist(table_name, 1, 30);
                })
            )
          );
          tt.append($('<option />').text(val[1]));
          ct.append($('<option />').text(val[1]));
        });
      }
    });
  },
  tablelist: function() {
    $.ajax({
      url: '/a/tablelist',
      data: {},
      dataType: 'json',
      success: function(d) {
        var table = GroongaAdmin.create_table_element(d);
        $('#database-tab-tablelist').empty().append($('<h1/>').text('テーブル一覧')).append(table);
        table.find('tr').each(function() {
          var table_name_td = $(this).find('td:eq(1)');
          var table_name = table_name_td.text();
          table_name_td.text('');
          table_name_td.append(
            $('<a/>').attr('href', '#')
              .text(table_name)
              .click(function() {
                GroongaAdmin.recordlist(table_name);
            }));
        });
      }
    });
  },
  recordlist: function(table_name, offset, count) {
    $.ajax({
      url: '/a/recordlist',
      data: {
        'table': table_name,
        'offset': offset,
        'count': count
        /* sort_column: :id */
      },
      dataType: 'json',
      success: function(d) {
        $('#table-tab-recordlist')
          .empty()
          .append($('<h1/>').text('レコード一覧'))
          .append(GroongaAdmin.create_table_element(d));
      }
    });
  },
  columnlist: function(table_name) {
    $.ajax({
      url: '/a/columnlist',
      data: {'table': table_name},
      dataType: 'json',
      success: function(d) {
        $('#table-tab-columnlist')
          .empty()
          .append($('<h1/>').text('カラム一覧'))
          .append(GroongaAdmin.create_table_element(d));
      }
    });
  },
  createtable: function() {
    var flags = 0;
    $('#createtable-flags>input:checked').each(function() {
      flags |= Groonga[$(this).val()];
    });
    flags |= Groonga[$('#createtable-key-index').val()];
    $.ajax({
      url: '/a/createtable',
      data: {
        name: $('#createtable-name').val(),
        'flags': flags,
        key_type: $('#createtable-key-type').val(),
        value_size: $('#createtable-value-size').val()
      },
      dataType: 'json',
      success: function(d) {
        if (d) {
          alert('テーブルを作成しました。');
          GroongaAdmin.update_tablelist();
        } else {
          alert('テーブルが作成できませんでした。');
        }
      }
    });
  },
  createcolumn: function() {
    var flags = 0;
    $('#createcolumn-flags>input:checked').each(function() {
      flags |= Groonga[$(this).val()];
    });
    $('#createcolumn-ii-flags>input:checked').each(function() {
      flags |= Groonga[$(this).val()];
    });
    flags |= Groonga[$('#createcolumn-column-type').val()];
    flags |= Groonga[$('#createcolumn-column-compress').val()];
    $.ajax({
      url: '/a/createcolumn',
      data: {
        table: GroongaAdmin.current_table,
        name: $('#createcolumn-name').val(),
        'flags': flags,
        type: $('#createcolumn-type').val()
      },
      dataType: 'json',
      success: function(d) {
        if (d) {
          alert('カラムを作成しました。');
        } else {
          alert('カラムが作成できませんでした。');
        }
      }
    });
  }
};
$(function() {
  GroongaAdmin.initialize();
  GroongaAdmin.tablelist();
});
</script>
</body>
</html>
